n = 1000;
static data = "Hello there sailor\n";

printf("0\n");
static
echo_client(n, port)
{
    sock := net.connect(net.socket("tcp/ip"), port);
    for (i := 0; i < n; ++i)
    {
        net.send(sock, data);
        if ((ans := net.recv(sock, nels(data))) != data)
            fail(sprintf("received \"%s\", expected \"%s\"", ans, data));
    }
    net.close(sock);
    return 1;
}

printf("1\n");
ssock = net.listen(net.bind(net.socket("tcp/ip")));
printf("2\n");
client = thread(echo_client, n, net.getportno(ssock));
printf("3\n");
csock = net.accept(ssock);
t = 0;
printf("A\n");
while (str = net.recv(csock, nels(data)))
{
    net.send(csock, str);
    t += nels(str);
}
waitfor(client.state != "active"; client)
    ;

if (t != n * nels(data))
    fail("didn't process right amount of data");
